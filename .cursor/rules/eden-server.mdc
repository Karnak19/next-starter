---
description: Rules for using Eden Treaty API client in server components
globs: src/**/*.tsx, src/**/*.ts, app/**/*.tsx, app/**/*.ts
alwaysApply: false
---

# Eden Server-Side API Calls

This project uses Eden Treaty for type-safe API calls. There are two clients:

## Client-Side (`@/shared/api`)

For client components and TanStack Query:

```typescript
"use client";

import { api } from "@/shared/api";
import { useQuery } from "@tanstack/react-query";
import { meQueryOptions } from "@/shared/api";

// Direct call
const { data } = await api.health.get();

// With TanStack Query
const { data } = useQuery(meQueryOptions);
```

## Server-Side (`@/shared/api/eden.server`)

For server components. Uses direct function calls (no HTTP overhead).

### Public Endpoints (no auth)

```typescript
import { api } from "@/shared/api/eden.server";

async function MyServerComponent() {
  const { data, error } = await api.health.get();
  // ...
}
```

### Authenticated Endpoints

Pass request headers for auth cookies:

```typescript
import { headers } from "next/headers";
import { api } from "@/shared/api/eden.server";

async function MyServerComponent() {
  const h = await headers();
  
  const { data, error } = await api.me.get({
    headers: Object.fromEntries(h.entries()),
  });
  // ...
}
```

## Key Rules

1. **Server components** → import from `@/shared/api/eden.server`
2. **Client components** → import from `@/shared/api`
3. **Auth required** → pass `headers` option with request headers
4. **No auth** → call without headers option
5. **Never import `eden.server` in client components** - it's protected by `server-only`

## Pattern: Streaming with Suspense

```typescript
import { headers } from "next/headers";
import { Suspense } from "react";
import { api } from "@/shared/api/eden.server";

async function UserData() {
  const h = await headers();
  const { data } = await api.me.get({
    headers: Object.fromEntries(h.entries()),
  });
  
  return <div>{data?.user?.name}</div>;
}

function UserDataSkeleton() {
  return <div className="animate-pulse h-4 w-24 bg-zinc-200 rounded" />;
}

// In parent component
<Suspense fallback={<UserDataSkeleton />}>
  <UserData />
</Suspense>
```

## Why Two Clients?

| Client | Import | Use Case | How it Works |
|--------|--------|----------|--------------|
| `eden.ts` | `@/shared/api` | Client components, TanStack Query | HTTP request to origin |
| `eden.server.ts` | `@/shared/api/eden.server` | Server components | Direct function call via `treaty(app)` |

The server client imports the actual Elysia app instance, enabling direct calls without HTTP. This is faster but only works server-side.
